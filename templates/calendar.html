{% extends "base.html" %}
{% block content %}
<div id='calendar'></div>

<div id="attendanceModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h3 id="modalDate"></h3>
        <p>Chọn trạng thái:</p>
        <div class="modal-buttons">
            <button id="presentBtn" class="btn-present">✅ Đi Làm</button>
            <button id="absentBtn" class="btn-absent">❌ Không Đi Làm</button>
        </div>
        <textarea id="noteInput" placeholder="Thêm ghi chú..."></textarea>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var modal = document.getElementById('attendanceModal');
    var selectedDate = null;
    var presentBtn = document.getElementById('presentBtn');
    var absentBtn = document.getElementById('absentBtn');
    var noteInput = document.getElementById('noteInput');

    var isMobile = window.innerWidth <= 768;

    var calendarOptions = {
        initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        locale: 'vi',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: isMobile ? 'listWeek,dayGridMonth' : 'dayGridMonth'
        },
        events: '/api/attendance',
    };

    if ({{ is_admin | tojson }}) {
        calendarOptions.dateClick = function(info) {
            selectedDate = info.dateStr;
            document.getElementById('modalDate').innerText = 'Chấm công: ' + info.dateStr;
            
            let event = calendar.getEvents().find(e => e.startStr === info.dateStr);

            // Reset modal
            noteInput.value = '';
            presentBtn.classList.remove('active-status');
            absentBtn.classList.remove('active-status');

            // Nếu có sự kiện cũ, điền lại thông tin
            if (event) {
                let props = event.extendedProps;
                noteInput.value = props.note || '';
                if (props.status === 'Đi làm') {
                    presentBtn.classList.add('active-status');
                } else if (props.status === 'Không đi làm') {
                    absentBtn.classList.add('active-status');
                }
            }
            
            modal.style.display = 'block';
        };
    }

    var calendar = new FullCalendar.Calendar(calendarEl, calendarOptions);
    calendar.render();

    if ({{ is_admin | tojson }}) {
        function saveAttendance(status) {
            fetch('/api/attendance', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    date: selectedDate, 
                    status: status, 
                    note: noteInput.value
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    calendar.refetchEvents();
                    modal.style.display = 'none';
                }
            });
        }

        presentBtn.onclick = () => saveAttendance('Đi làm');
        absentBtn.onclick = () => saveAttendance('Không đi làm');
        document.querySelector('.close-button').onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == modal) modal.style.display = 'none';
        };
    }
});
</script>
{% endblock %}